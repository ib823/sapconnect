/**
 * Test Scenario Engine
 *
 * Auto-generates test scenarios from migration objects, business process
 * definitions, and transaction usage patterns. Produces executable test
 * cases for comparison (source vs target), process (E2E workflows),
 * regression (before/after), and performance testing.
 *
 * This is the core of the "6 months → 2 hours" promise:
 * instead of manually writing hundreds of test scripts,
 * the engine generates them from metadata.
 */

const Logger = require('../lib/logger');

class TestScenarioEngine {
  constructor(options = {}) {
    this.logger = new Logger('test-engine', { level: options.verbose ? 'debug' : 'info' });
    this.modules = options.modules || null; // null = all
  }

  /**
   * Generate all test scenarios from a set of migration objects.
   * @param {Array} migrationResults - Array of run() results from migration objects
   * @param {object} usageData - Optional transaction usage data (from UsageAnalyzer)
   * @returns {object} Complete test suite
   */
  generateFromMigrationResults(migrationResults, usageData = null) {
    this.logger.debug(`Generating tests from ${migrationResults.length} migration results`);

    const scenarios = {
      comparison: [],
      process: [],
      regression: [],
      performance: [],
    };

    for (const result of migrationResults) {
      // Comparison tests: verify record counts and field values match
      scenarios.comparison.push(...this._generateComparisonScenarios(result));

      // Regression tests: verify key fields weren't corrupted
      scenarios.regression.push(...this._generateRegressionScenarios(result));
    }

    // Process tests from business process catalog
    scenarios.process.push(...this._generateProcessScenarios());

    // Performance tests from usage patterns
    if (usageData) {
      scenarios.performance.push(...this._generatePerformanceScenarios(usageData));
    }

    const stats = {
      comparison: scenarios.comparison.length,
      process: scenarios.process.length,
      regression: scenarios.regression.length,
      performance: scenarios.performance.length,
      total: scenarios.comparison.length + scenarios.process.length +
             scenarios.regression.length + scenarios.performance.length,
    };

    this.logger.info(`Generated ${stats.total} test scenarios`);

    return { scenarios, stats };
  }

  /**
   * Generate comparison (reconciliation) scenarios from a migration result.
   */
  _generateComparisonScenarios(result) {
    const scenarios = [];
    const { objectId, name, phases } = result;

    if (!phases || !phases.extract) return scenarios;

    // Record count comparison
    scenarios.push({
      id: `CMP-${objectId}-COUNT`,
      type: 'comparison',
      objectId,
      name: `${name} - Record Count`,
      description: `Verify ${name} record count matches between source and target`,
      priority: 'critical',
      sourceAssertion: { metric: 'recordCount', expected: phases.extract.recordCount },
      targetAssertion: { metric: 'recordCount', tolerance: 0 },
      autoGenerated: true,
    });

    // Load success comparison
    if (phases.load) {
      scenarios.push({
        id: `CMP-${objectId}-LOAD`,
        type: 'comparison',
        objectId,
        name: `${name} - Load Success Rate`,
        description: `Verify ${name} load success rate ≥ 98%`,
        priority: 'high',
        sourceAssertion: { metric: 'loadedRecords', expected: phases.load.successCount || phases.load.recordCount },
        targetAssertion: { metric: 'successRate', minPercent: 98 },
        autoGenerated: true,
      });
    }

    // Validation quality comparison
    if (phases.validate) {
      scenarios.push({
        id: `CMP-${objectId}-QUALITY`,
        type: 'comparison',
        objectId,
        name: `${name} - Data Quality`,
        description: `Verify ${name} passes data quality checks with zero errors`,
        priority: 'high',
        sourceAssertion: { metric: 'errorCount', expected: phases.validate.errorCount || 0 },
        targetAssertion: { metric: 'errorCount', maxAllowed: 0 },
        autoGenerated: true,
      });
    }

    return scenarios;
  }

  /**
   * Generate regression scenarios to verify data integrity post-migration.
   */
  _generateRegressionScenarios(result) {
    const scenarios = [];
    const { objectId, name, phases } = result;

    if (!phases || !phases.transform) return scenarios;

    // Field completeness regression
    scenarios.push({
      id: `REG-${objectId}-FIELDS`,
      type: 'regression',
      objectId,
      name: `${name} - Field Completeness`,
      description: `Verify all mapped fields for ${name} have values in target`,
      priority: 'medium',
      check: 'field_completeness',
      mappingCount: phases.transform.mappingSummary?.totalMappings || 0,
      autoGenerated: true,
    });

    // No data loss regression
    scenarios.push({
      id: `REG-${objectId}-NOLOSS`,
      type: 'regression',
      objectId,
      name: `${name} - No Data Loss`,
      description: `Verify no records lost during ${name} transform/load`,
      priority: 'critical',
      check: 'no_data_loss',
      extractCount: phases.extract.recordCount,
      transformCount: phases.transform.recordCount,
      autoGenerated: true,
    });

    return scenarios;
  }

  /**
   * Generate end-to-end business process test scenarios.
   * These cover the critical business flows that must work after go-live.
   */
  _generateProcessScenarios() {
    const catalog = this._getProcessCatalog();
    const scenarios = [];

    for (const process of catalog) {
      if (this.modules && !this.modules.includes(process.module)) continue;

      scenarios.push({
        id: process.id,
        type: 'process',
        module: process.module,
        name: process.name,
        description: process.description,
        priority: process.priority,
        steps: process.steps,
        expectedOutcome: process.expectedOutcome,
        prerequisites: process.prerequisites || [],
        estimatedDurationSec: process.estimatedDurationSec || 60,
        autoGenerated: true,
      });
    }

    return scenarios;
  }

  /**
   * Business process catalog — exhaustive E2E flows per module.
   */
  _getProcessCatalog() {
    return [
      // ── Finance (FI) ──────────────────────────────────────────
      {
        id: 'PROC-FI-001', module: 'FI', name: 'GL Journal Entry',
        description: 'Post a GL journal entry and verify ACDOCA',
        priority: 'critical', estimatedDurationSec: 30,
        steps: [
          { action: 'POST', api: 'API_JOURNALENTRYITEMBASIC_SRV', data: 'GL header + 2 line items' },
          { action: 'VERIFY', check: 'Document number assigned' },
          { action: 'VERIFY', check: 'Line items in ACDOCA with correct amounts' },
          { action: 'VERIFY', check: 'GL account balances updated' },
        ],
        expectedOutcome: 'FI document posted, ACDOCA entries created',
      },
      {
        id: 'PROC-FI-002', module: 'FI', name: 'Customer Invoice',
        description: 'Post AR invoice and verify open item',
        priority: 'critical', estimatedDurationSec: 30,
        steps: [
          { action: 'POST', api: 'API_JOURNALENTRYITEMBASIC_SRV', data: 'AR invoice with tax' },
          { action: 'VERIFY', check: 'Customer open item created' },
          { action: 'VERIFY', check: 'Tax line posted correctly' },
          { action: 'VERIFY', check: 'Revenue GL account credited' },
        ],
        expectedOutcome: 'AR invoice posted, customer open item visible',
      },
      {
        id: 'PROC-FI-003', module: 'FI', name: 'Incoming Payment',
        description: 'Post customer payment and clear open item',
        priority: 'critical', estimatedDurationSec: 30,
        steps: [
          { action: 'POST', api: 'API_JOURNALENTRYITEMBASIC_SRV', data: 'Incoming payment' },
          { action: 'VERIFY', check: 'Open item cleared' },
          { action: 'VERIFY', check: 'Bank GL account debited' },
        ],
        expectedOutcome: 'Payment clears open item, bank updated',
      },
      {
        id: 'PROC-FI-004', module: 'FI', name: 'Vendor Invoice',
        description: 'Post AP invoice against purchase order',
        priority: 'critical', estimatedDurationSec: 30,
        steps: [
          { action: 'POST', api: 'API_SUPPLIERINVOICE_PROCESS_SRV', data: 'Vendor invoice with PO ref' },
          { action: 'VERIFY', check: 'Vendor open item created' },
          { action: 'VERIFY', check: 'GR/IR account cleared' },
        ],
        expectedOutcome: 'AP invoice posted, vendor liability created',
      },
      {
        id: 'PROC-FI-005', module: 'FI', name: 'Payment Run',
        description: 'Execute automatic payment program',
        priority: 'high', estimatedDurationSec: 60,
        steps: [
          { action: 'EXECUTE', api: 'Payment proposal run' },
          { action: 'VERIFY', check: 'Payment proposal created' },
          { action: 'EXECUTE', api: 'Payment execution' },
          { action: 'VERIFY', check: 'Payment documents created' },
          { action: 'VERIFY', check: 'Bank file generated' },
        ],
        expectedOutcome: 'Payments executed, bank file ready',
      },
      {
        id: 'PROC-FI-006', module: 'FI', name: 'Asset Acquisition',
        description: 'Post asset acquisition and verify depreciation start',
        priority: 'high', estimatedDurationSec: 30,
        steps: [
          { action: 'POST', api: 'API_FIXEDASSET_SRV', data: 'Asset acquisition posting' },
          { action: 'VERIFY', check: 'Asset master updated' },
          { action: 'VERIFY', check: 'Depreciation area values set' },
          { action: 'VERIFY', check: 'GL accounts posted (asset + offset)' },
        ],
        expectedOutcome: 'Asset acquired, depreciation schedule started',
      },
      {
        id: 'PROC-FI-007', module: 'FI', name: 'Period Close',
        description: 'Execute FI period-end closing activities',
        priority: 'high', estimatedDurationSec: 120,
        steps: [
          { action: 'EXECUTE', api: 'Foreign currency valuation' },
          { action: 'EXECUTE', api: 'GR/IR clearing' },
          { action: 'EXECUTE', api: 'Depreciation run' },
          { action: 'EXECUTE', api: 'Balance carry forward' },
          { action: 'VERIFY', check: 'All posting periods balanced' },
        ],
        expectedOutcome: 'Period closed, balances carried forward',
      },

      // ── Procurement (MM) ──────────────────────────────────────
      {
        id: 'PROC-MM-001', module: 'MM', name: 'Procure to Pay',
        description: 'Full P2P cycle: PR → PO → GR → IR → Payment',
        priority: 'critical', estimatedDurationSec: 120,
        steps: [
          { action: 'CREATE', api: 'API_PURCHASEREQUISITION_PROCESS_SRV', data: 'Purchase requisition' },
          { action: 'CREATE', api: 'API_PURCHASEORDER_PROCESS_SRV', data: 'PO from requisition' },
          { action: 'POST', api: 'API_MATERIAL_DOCUMENT_SRV', data: 'Goods receipt against PO' },
          { action: 'VERIFY', check: 'Stock quantity increased' },
          { action: 'POST', api: 'API_SUPPLIERINVOICE_PROCESS_SRV', data: 'Invoice receipt' },
          { action: 'VERIFY', check: '3-way match passed' },
          { action: 'VERIFY', check: 'Vendor open item created' },
        ],
        expectedOutcome: 'Full P2P cycle completed',
      },
      {
        id: 'PROC-MM-002', module: 'MM', name: 'Stock Transfer',
        description: 'Transfer stock between plants',
        priority: 'high', estimatedDurationSec: 30,
        steps: [
          { action: 'POST', api: 'API_MATERIAL_DOCUMENT_SRV', data: 'Transfer posting 301' },
          { action: 'VERIFY', check: 'Source plant stock decreased' },
          { action: 'VERIFY', check: 'Target plant stock increased' },
        ],
        expectedOutcome: 'Stock transferred between plants',
      },
      {
        id: 'PROC-MM-003', module: 'MM', name: 'Inventory Count',
        description: 'Physical inventory count and adjustment',
        priority: 'medium', estimatedDurationSec: 60,
        steps: [
          { action: 'CREATE', api: 'Physical inventory document' },
          { action: 'POST', api: 'Count results entry' },
          { action: 'POST', api: 'Inventory difference posting' },
          { action: 'VERIFY', check: 'Stock adjusted to counted quantity' },
        ],
        expectedOutcome: 'Inventory adjusted to physical count',
      },

      // ── Sales (SD) ────────────────────────────────────────────
      {
        id: 'PROC-SD-001', module: 'SD', name: 'Order to Cash',
        description: 'Full O2C cycle: SO → Delivery → Billing → Payment',
        priority: 'critical', estimatedDurationSec: 120,
        steps: [
          { action: 'CREATE', api: 'API_SALES_ORDER_SRV', data: 'Standard sales order' },
          { action: 'VERIFY', check: 'Pricing calculated correctly' },
          { action: 'VERIFY', check: 'Availability confirmed' },
          { action: 'CREATE', api: 'API_OUTBOUND_DELIVERY_SRV', data: 'Outbound delivery' },
          { action: 'POST', api: 'Goods issue', data: 'Post goods issue' },
          { action: 'VERIFY', check: 'Stock reduced' },
          { action: 'CREATE', api: 'API_BILLING_DOCUMENT_SRV', data: 'Billing document' },
          { action: 'VERIFY', check: 'FI document created' },
          { action: 'VERIFY', check: 'Customer receivable posted' },
        ],
        expectedOutcome: 'Full O2C cycle completed, revenue recognized',
      },
      {
        id: 'PROC-SD-002', module: 'SD', name: 'Returns Processing',
        description: 'Customer return with credit memo',
        priority: 'high', estimatedDurationSec: 60,
        steps: [
          { action: 'CREATE', api: 'API_SALES_ORDER_SRV', data: 'Returns order (RE)' },
          { action: 'CREATE', api: 'Return delivery' },
          { action: 'POST', api: 'Goods receipt for return' },
          { action: 'CREATE', api: 'Credit memo' },
          { action: 'VERIFY', check: 'Customer credit posted' },
        ],
        expectedOutcome: 'Return processed, credit issued',
      },
      {
        id: 'PROC-SD-003', module: 'SD', name: 'Credit Memo',
        description: 'Create standalone credit memo',
        priority: 'medium', estimatedDurationSec: 30,
        steps: [
          { action: 'CREATE', api: 'Credit memo request' },
          { action: 'CREATE', api: 'Credit memo billing' },
          { action: 'VERIFY', check: 'Customer receivable reduced' },
        ],
        expectedOutcome: 'Credit memo posted',
      },

      // ── Controlling (CO) ──────────────────────────────────────
      {
        id: 'PROC-CO-001', module: 'CO', name: 'Internal Order Settlement',
        description: 'Settle internal order to cost center',
        priority: 'high', estimatedDurationSec: 30,
        steps: [
          { action: 'EXECUTE', api: 'Settlement run for internal order' },
          { action: 'VERIFY', check: 'Costs transferred to receiver' },
          { action: 'VERIFY', check: 'ACDOCA entries created for settlement' },
        ],
        expectedOutcome: 'Internal order settled to receiver',
      },
      {
        id: 'PROC-CO-002', module: 'CO', name: 'Cost Center Allocation',
        description: 'Run assessment/distribution cycle',
        priority: 'high', estimatedDurationSec: 60,
        steps: [
          { action: 'EXECUTE', api: 'Assessment cycle run' },
          { action: 'VERIFY', check: 'Sender cost center debited' },
          { action: 'VERIFY', check: 'Receiver cost centers credited' },
        ],
        expectedOutcome: 'Costs allocated per cycle rules',
      },

      // ── Production (PP) ───────────────────────────────────────
      {
        id: 'PROC-PP-001', module: 'PP', name: 'Production Order Execution',
        description: 'Create, release, confirm, and complete production order',
        priority: 'high', estimatedDurationSec: 120,
        steps: [
          { action: 'CREATE', api: 'Production order from planned order' },
          { action: 'EXECUTE', api: 'Release production order' },
          { action: 'POST', api: 'Component goods issue (backflush)' },
          { action: 'POST', api: 'Confirmation (time and quantity)' },
          { action: 'POST', api: 'Goods receipt of finished product' },
          { action: 'VERIFY', check: 'Finished goods stock increased' },
          { action: 'VERIFY', check: 'Component stock decreased' },
        ],
        expectedOutcome: 'Production order completed, FG in stock',
      },

      // ── Quality (QM) ─────────────────────────────────────────
      {
        id: 'PROC-QM-001', module: 'QM', name: 'Inspection at GR',
        description: 'Quality inspection triggered by goods receipt',
        priority: 'medium', estimatedDurationSec: 60,
        steps: [
          { action: 'TRIGGER', api: 'Goods receipt triggers inspection lot' },
          { action: 'POST', api: 'Record inspection results' },
          { action: 'POST', api: 'Usage decision (accept/reject)' },
          { action: 'VERIFY', check: 'Stock posted to unrestricted (if accepted)' },
        ],
        expectedOutcome: 'Inspection completed, stock released',
      },

      // ── Project System (PS) ───────────────────────────────────
      {
        id: 'PROC-PS-001', module: 'PS', name: 'Project Lifecycle',
        description: 'Create project, plan costs, release, confirm, settle',
        priority: 'medium', estimatedDurationSec: 120,
        steps: [
          { action: 'CREATE', api: 'API_PROJECT_V2', data: 'Project definition + WBS' },
          { action: 'EXECUTE', api: 'Budget allocation' },
          { action: 'EXECUTE', api: 'Release project' },
          { action: 'POST', api: 'Activity confirmation' },
          { action: 'EXECUTE', api: 'Period-end settlement' },
          { action: 'VERIFY', check: 'Costs settled to receivers' },
        ],
        expectedOutcome: 'Project executed and settled',
      },
    ];
  }

  /**
   * Generate performance test scenarios from usage patterns.
   */
  _generatePerformanceScenarios(usageData) {
    const scenarios = [];

    // Top transactions by volume
    const topTransactions = usageData.topTransactions || [];
    for (const tx of topTransactions.slice(0, 10)) {
      scenarios.push({
        id: `PERF-TX-${tx.tcode || tx.transaction}`,
        type: 'performance',
        name: `Performance: ${tx.tcode || tx.transaction}`,
        description: `Verify ${tx.tcode || tx.transaction} response time within SLA`,
        priority: tx.dailyVolume > 1000 ? 'critical' : 'high',
        transaction: tx.tcode || tx.transaction,
        dailyVolume: tx.dailyVolume || tx.executions,
        targetResponseSec: tx.dailyVolume > 5000 ? 2 : 5,
        autoGenerated: true,
      });
    }

    return scenarios;
  }
}

module.exports = TestScenarioEngine;
